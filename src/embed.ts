import { APIEmbed } from "discord-api-types/v10"
import { decodeAddress, encodeAddress } from "./address"
import { EmbedMail, PostalMail } from "./types"

export function makeEmbed(email: PostalMail): APIEmbed {
	return {
		title: email.subject,
		description: (email.text || parseHTML(email.html)).trim().substring(0, 4096) || "No content found",
		author: {
			name: encodeAddress(email.from)
		},
		footer: {
			text: `Sent to ${encodeAddress(email.to[0])}, Reply to ${encodeAddress(email.replyTo)}`
		},
		timestamp: new Date(email.date).toISOString(),
		color: 0x2f3136,
	}
}

export function parseEmbed(embed: APIEmbed): EmbedMail {
	return {
		subject: embed.title as string,
		body: embed.description as string,
		to: decodeAddress(embed.footer?.text.substring(8) as string),
		from: decodeAddress(embed.author?.name as string),
		timestamp: embed.timestamp as string,
	}
}

function parseHTML(html: string): string {
	html = html.replace(/<!doctype[^>]+>/i, "");
	html = html.replace(/<head>.*?<\/head>/i, "");
	html = html.replace(/<style[^>]*>.*?<\/style>/gi, "");
	html = html.replace(/<script[^>]*>.*?<\/script>/gi, "");
	html = html.replace(/\n|\r/g, " ");
	html = html.replace(/&#?\w+;/g, " ");
	html = html.replace(/<br\s*?\/?>/gi, "\n");
	html = html.replace(/[ \t]+/g, " ");
	html = html.replace(/^\s+|\s+$/gm, "");
	html = html.replace('body { width: 100% !important; min-width: 100%; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; margin: 0; padding: 0; } .ExternalClass { width: 100%; } .ExternalClass { line-height: 100%; } #backgroundTable { margin: 0; padding: 0; width: 100% !important; line-height: 100% !important; } img { outline: none; text-decoration: none; -ms-interpolation-mode: bicubic; width: auto; max-width: 100%; float: left; clear: both; display: block; } body { color: #222222; font-family: "Helvetica", "Arial", sans-serif; font-weight: normal; padding: 0; margin: 0; text-align: left; line-height: 1.3; } body { font-size: 14px; line-height: 19px; } a:hover { color: #2795b6 !important; } a:active { color: #2795b6 !important; } a:visited { color: #2ba6cb !important; } h1 a:active { color: #2ba6cb !important; } h2 a:active { color: #2ba6cb !important; } h3 a:active { color: #2ba6cb !important; } h4 a:active { color: #2ba6cb !important; } h5 a:active { color: #2ba6cb !important; } h6 a:active { color: #2ba6cb !important; } h1 a:visited { color: #2ba6cb !important; } h2 a:visited { color: #2ba6cb !important; } h3 a:visited { color: #2ba6cb !important; } h4 a:visited { color: #2ba6cb !important; } h5 a:visited { color: #2ba6cb !important; } h6 a:visited { color: #2ba6cb !important; } table.button:hover td { background: #294347 !important; } table.button:visited td { background: #294347 !important; } table.button:active td { background: #294347 !important; } table.button:hover td a { color: #fff !important; } table.button:visited td a { color: #fff !important; } table.button:active td a { color: #fff !important; } table.button:hover td { background: #294347 !important; } table.tiny-button:hover td { background: #294347 !important; } table.small-button:hover td { background: #294347 !important; } table.medium-button:hover td { background: #294347 !important; } table.large-button:hover td { background: #294347 !important; } table.button:hover td a { color: #ffffff !important; } table.button:active td a { color: #ffffff !important; } table.button td a:visited { color: #ffffff !important; } table.tiny-button:hover td a { color: #ffffff !important; } table.tiny-button:active td a { color: #ffffff !important; } table.tiny-button td a:visited { color: #ffffff !important; } table.small-button:hover td a { color: #ffffff !important; } table.small-button:active td a { color: #ffffff !important; } table.small-button td a:visited { color: #ffffff !important; } table.medium-button:hover td a { color: #ffffff !important; } table.medium-button:active td a { color: #ffffff !important; } table.medium-button td a:visited { color: #ffffff !important; } table.large-button:hover td a { color: #ffffff !important; } table.large-button:active td a { color: #ffffff !important; } table.large-button td a:visited { color: #ffffff !important; } table.secondary:hover td { background: #d0d0d0 !important; color: #555; } table.secondary:hover td a { color: #555 !important; } table.secondary td a:visited { color: #555 !important; } table.secondary:active td a { color: #555 !important; } table.success:hover td { background: #457a1a !important; } table.alert:hover td { background: #970b0e !important; } body.outlook p { display: inline !important; } body { background: #fff; } body { color: #39596e; font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; font-weight: normal; padding: 0; margin: 0; text-align: left; line-height: 1.3; } @media only screen and (max-width: 600px) { table[class="body"] img { width: auto !important; height: auto !important; } table[class="body"] center { min-width: 0 !important; } table[class="body"] .container { width: 95% !important; } table[class="body"] .row { width: 100% !important; display: block !important; } table[class="body"] .wrapper { display: block !important; padding-right: 0 !important; } table[class="body"] .columns { table-layout: fixed !important; float: none !important; width: 100% !important; padding-right: 0px !important; padding-left: 0px !important; displ', "");
	html = html.replace('ay: block !important; } table[class="body"] .column { table-layout: fixed !important; float: none !important; width: 100% !important; padding-right: 0px !important; padding-left: 0px !important; display: block !important; } table[class="body"] .wrapper.first .columns { display: table !important; } table[class="body"] .wrapper.first .column { display: table !important; } table[class="body"] table.columns td { width: 100% !important; } table[class="body"] table.column td { width: 100% !important; } table[class="body"] .columns td.one { width: 8.333333% !important; } table[class="body"] .column td.one { width: 8.333333% !important; } table[class="body"] .columns td.two { width: 16.666666% !important; } table[class="body"] .column td.two { width: 16.666666% !important; } table[class="body"] .columns td.three { width: 25% !important; } table[class="body"] .column td.three { width: 25% !important; } table[class="body"] .columns td.four { width: 33.333333% !important; } table[class="body"] .column td.four { width: 33.333333% !important; } table[class="body"] .columns td.five { width: 41.666666% !important; } table[class="body"] .column td.five { width: 41.666666% !important; } table[class="body"] .columns td.six { width: 50% !important; } table[class="body"] .column td.six { width: 50% !important; } table[class="body"] .columns td.seven { width: 58.333333% !important; } table[class="body"] .column td.seven { width: 58.333333% !important; } table[class="body"] .columns td.eight { width: 66.666666% !important; } table[class="body"] .column td.eight { width: 66.666666% !important; } table[class="body"] .columns td.nine { width: 75% !important; } table[class="body"] .column td.nine { width: 75% !important; } table[class="body"] .columns td.ten { width: 83.333333% !important; } table[class="body"] .column td.ten { width: 83.333333% !important; } table[class="body"] .columns td.eleven { width: 91.666666% !important; } table[class="body"] .column td.eleven { width: 91.666666% !important; } table[class="body"] .columns td.twelve { width: 100% !important; } table[class="body"] .column td.twelve { width: 100% !important; } table[class="body"] td.offset-by-one { padding-left: 0 !important; } table[class="body"] td.offset-by-two { padding-left: 0 !important; } table[class="body"] td.offset-by-three { padding-left: 0 !important; } table[class="body"] td.offset-by-four { padding-left: 0 !important; } table[class="body"] td.offset-by-five { padding-left: 0 !important; } table[class="body"] td.offset-by-six { padding-left: 0 !important; } table[class="body"] td.offset-by-seven { padding-left: 0 !important; } table[class="body"] td.offset-by-eight { padding-left: 0 !important; } table[class="body"] td.offset-by-nine { padding-left: 0 !important; } table[class="body"] td.offset-by-ten { padding-left: 0 !important; } table[class="body"] td.offset-by-eleven { padding-left: 0 !important; } table[class="body"] table.columns td.expander { width: 1px !important; } table[class="body"] .right-text-pad { padding-left: 10px !important; } table[class="body"] .text-pad-right { padding-left: 10px !important; } table[class="body"] .left-text-pad { padding-right: 10px !important; } table[class="body"] .text-pad-left { padding-right: 10px !important; } table[class="body"] .hide-for-small { display: none !important; } table[class="body"] .show-for-desktop { display: none !important; } table[class="body"] .show-for-small { display: inherit !important; } table[class="body"] .hide-for-desktop { display: inherit !important; } p.quote { padding-left: 0px; border-left: none; } .signaturecontent { padding-bottom: 0px !important; } .signaturecontent--mobile { border-top: none; text-align: center; padding-top: 16px !important; } table[class="body"] .container { width: 80% !important; } .center--mobile { text-align: center; } }', "");
	return html.replace(/<\/?[^>]+?>/g, "")
}
